#!/sbin/sh

#-----------------------------------------------------------------------
# Назначение: Переразметка раздела boot с бэкапом GPT через ZIP в Recovery
# Версия: 1.3 (Universal Port)
# Автор: isus203
#-----------------------------------------------------------------------

# ======================================================================
#   ⚙️ КОНФИГУРАЦИЯ ДЛЯ ПОРТИРОВАНИЯ (РЕДАКТИРОВАТЬ ЗДЕСЬ)
# ======================================================================

# 1. УСТРОЙСТВО
# Путь к основному блоку памяти (mmcblk0 для EMMC, sda для UFS и т.д.)
DEVICE="/dev/block/mmcblk0"

# 2. ПУТИ
# Куда сохранять бэкапы и логи (внешняя карта или внутренняя память)
EXTERNAL_PATH="/external_sd"

# 3. ИМЕНА РАЗДЕЛОВ
# Как они называются в /dev/block/by-name/
BOOT_A_NAME="boot_a"
BOOT_B_NAME="boot_b"

# 4. НОМЕРА И СЕКТОРЫ (Смотреть через sgdisk -p)
# Номера удаляемых разделов
OLD_BOOT_A_NUM="30"
OLD_BOOT_B_NUM="31"

# Номера создаваемых разделов
NEW_BOOT_A_NUM="30"
NEW_BOOT_B_NUM="43"

# СЕКТОРЫ (Начало:Конец) - САМОЕ ВАЖНОЕ!
# Пример: 1003520:1200127
BOOT_A_SECTORS="1003520:1200127"
BOOT_B_SECTORS="1708032:1904639"

# ======================================================================
#           ⛔ КОНЕЦ НАСТРОЕК (ДАЛЕЕ КОД НЕ ТРОГАТЬ)
# ======================================================================

# Аргументы update-binary
OUTFD="/proc/self/fd/$2"
ZIPFILE="$3"

# Пути к устройству и временным файлам
SGDISK="/tmp/sgdisk"
BOOT_IMG="/tmp/boot.img"
LOGFILE="$EXTERNAL_PATH/repartition.log"
GPT_SDCARD="$EXTERNAL_PATH/gpt_backup.bin"
BACKUP_DIR="/tmp/backup"
BACKUP_GPT="/tmp/backup/gpt_backup.bin"
GPT_BACKUP_ZIP="$EXTERNAL_PATH/gpt_partition_backup_$(date '+%Y%m%d_%H%M%S').zip"

# Вывод сообщений в Recovery UI + лог
ui_print() {
    echo -e "ui_print $1\nui_print" >> "$OUTFD"
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOGFILE"
}

# Баннер
display_banner() {
    ui_print ""
    ui_print "=========================================="
    ui_print "     Repartition Boot + GPT Backup installer"
    ui_print "                By isus203 (v1.3)              "
    ui_print "=========================================="
    ui_print ""
}

# Распаковка ZIP в /tmp
extract_package() {
    ui_print "Unpacking the archive..."
    mkdir -p /tmp
    mkdir -p /tmp/backup
    unzip -o "$ZIPFILE" -d /tmp
    if [ $? -ne 0 ]; then
        ui_print "Unpacking error!"
        exit 1
    fi
}

# Проверка наличия необходимых файлов
check_files() {
    for f in "$SGDISK" "$BOOT_IMG"; do
        if [ ! -f "$f" ]; then
            ui_print "File not found: $f"
            exit 1
        fi
    done
}

# Права
set_permissions() {
    ui_print "Issuance of rights..."
    chmod 755 "$SGDISK"
    chmod 755 "$BOOT_IMG"
}

# Бэкап GPT
backup_gpt() {
    ui_print "Creating a backup GPT..."
    "$SGDISK" -b "$BACKUP_GPT" "$DEVICE"
    if [ $? -ne 0 ]; then
        ui_print "Backup error GPT!"
        exit 1
    fi
    
    # Копируем Sgdisk/backup GPT
    cp "$SGDISK" "$BACKUP_DIR" 2>/dev/null  
    dd if="/dev/block/by-name/$BOOT_A_NAME" of="$BACKUP_DIR/boot_a.img" bs=4M >> "$LOGFILE" 2>&1
    if [ $? -eq 0 ]; then
        ui_print "GPT backup saved: $BACKUP_DIR"
    else
        ui_print "Failed to save backup to $BACKUP_DIR"
    fi
    
    # Копируем на SD-карту
    cp "$BACKUP_GPT" "$GPT_SDCARD" 2>/dev/null
    if [ $? -eq 0 ]; then
        ui_print "GPT backup saved: $GPT_SDCARD"
    else
        ui_print "Failed to save backup to SD card, but it is in /tmp"
    fi
     
# Скрипт восстановления
mkdir -p "$BACKUP_DIR/META-INF/com/google/android"
cat > "$BACKUP_DIR/META-INF/com/google/android/update-binary" << EOF
#!/sbin/sh
OUTFD="/proc/self/fd/\$2"
DEVICE="$DEVICE"
SGDISK="/tmp/sgdisk"
BOOT_IMG="/tmp/boot_a.img"

ui_print() {
    echo -e "ui_print \$1\nui_print" >> "\$OUTFD"
}

ui_print ""
ui_print "=========================================="
ui_print "         GPT Backup installer      "
ui_print "              By isus203                "
ui_print "=========================================="
ui_print ""

ui_print "GPT and partition recovery..."
mkdir -p /tmp
unzip -o "\$3" -d /tmp

ui_print "Issuance of rights..."
chmod 755 "\$SGDISK"
chmod 644 "\$BOOT_IMG"

"\$SGDISK" -l /tmp/gpt_backup.bin "\$DEVICE"
dd if=/tmp/boot_a.img of=/dev/block/by-name/$BOOT_A_NAME
dd if=/tmp/boot_a.img of=/dev/block/by-name/$BOOT_B_NAME
ui_print "Recovery complete"
exit 0
EOF
    chmod +x "$BACKUP_DIR/META-INF/com/google/android/update-binary"

cat > "$BACKUP_DIR/META-INF/com/google/android/update-script" << EOF
# Dummy file; update-binary is a shell script.
EOF

chmod +x "$BACKUP_DIR/META-INF/com/google/android/update-script"

    # Архивация
    ui_print "Backup archiving..."
    (cd "$BACKUP_DIR" && zip -r "$BACKUP_ZIP" .) >> "$LOGFILE" 2>&1
    ui_print "The backup has been saved.: $BACKUP_ZIP"
    
    (cd "$BACKUP_DIR" && zip -r "$GPT_BACKUP_ZIP" .) >> "$LOGFILE" 2>&1
    ui_print "The backup has been saved.: $GPT_BACKUP_ZIP"
}

# Переразметка boot
repartition_boot() {
    ui_print "Re-marking boot..."
      "$SGDISK" "$DEVICE" -d $OLD_BOOT_A_NUM -d $OLD_BOOT_B_NUM -n $NEW_BOOT_A_NUM:$BOOT_A_SECTORS -c $NEW_BOOT_A_NUM:$BOOT_A_NAME -t $NEW_BOOT_A_NUM:0700
    if [ $? -ne 0 ]; then exit 1; fi
      "$SGDISK" "$DEVICE" -d $NEW_BOOT_B_NUM -d $OLD_BOOT_B_NUM -n $NEW_BOOT_B_NUM:$BOOT_B_SECTORS -c $NEW_BOOT_B_NUM:$BOOT_B_NAME -t $NEW_BOOT_B_NUM:0700
    if [ $? -ne 0 ]; then exit 1; fi
      "$SGDISK" "$DEVICE" -s
    if [ $? -ne 0 ]; then exit 1; fi
    ui_print "Re-marking is complete."
}

# Прошивка preloader и boot
flash_firmware() {
    ui_print "Firmware boot..."
    dd if="$BOOT_IMG" of="/dev/block/by-name/$BOOT_A_NAME" >> "$LOGFILE" 2>&1
    if [ $? -ne 0 ]; then exit 1; fi
    dd if="$BOOT_IMG" of="/dev/block/by-name/$BOOT_B_NAME" >> "$LOGFILE" 2>&1
    if [ $? -ne 0 ]; then exit 1; fi
    ui_print "The firmware is complete."
}

# Запуск
ui_print ""
display_banner
extract_package
check_files
set_permissions
backup_gpt
repartition_boot
flash_firmware

ui_print "The operation was completed successfully."
